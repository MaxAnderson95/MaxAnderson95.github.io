---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Navbar from "../../components/Navbar";
import BlogCard from "../../components/BlogCard";
import Footer from "../../components/Footer";
import { getCollection } from "astro:content";
import { formatDateShort, sortPostsByDate } from "../../lib/utils";

export async function getStaticPaths() {
  const allPosts = await getCollection("blog");
  const posts = import.meta.env.DEV
    ? allPosts
    : allPosts.filter((post: any) => !post.data.draft);

  const tags = new Set<string>();
  for (const post of posts as any[]) {
    for (const tag of post.data.tags) {
      tags.add(tag);
    }
  }

  return [...tags].map((tag) => ({
    params: {
      tag: tag
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, "")
        .trim()
        .replace(/\s+/g, "-"),
    },
    props: { tag },
  }));
}

const { tag } = Astro.props;
const allPosts = await getCollection("blog");
const visiblePosts = import.meta.env.DEV
  ? allPosts
  : allPosts.filter((post: any) => !post.data.draft);
const posts = sortPostsByDate(
  visiblePosts.filter((post: any) => post.data.tags.includes(tag)) as any
);
---

<BaseLayout title={`${tag} — Tags — Max Anderson`}>
  <Navbar active="blog" client:idle />

  <main class="relative z-10 max-w-[1100px] mx-auto px-6 md:px-10 pt-28 pb-20">
    <div class="reveal mb-10" style="animation-delay: 0.15s;">
      <a
        href="/tags/"
        class="group inline-flex items-center gap-2 text-[13px] text-text-muted hover:text-accent transition-colors mb-7"
      >
        <svg
          class="w-4 h-4 transition-transform duration-200 group-hover:-translate-x-0.5"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="m15 18-6-6 6-6" />
        </svg>
        Back to all tags
      </a>

      <h1 class="font-display font-extrabold text-[clamp(2rem,5vw,3rem)] tracking-tight leading-tight text-text">
        #{tag}
      </h1>
      <p class="text-text-secondary text-[17px] mt-3 max-w-xl">
        {posts.length} {posts.length === 1 ? "post" : "posts"} tagged with {tag}.
      </p>
    </div>

    <div class="grid gap-4 md:grid-cols-2">
      {posts.map((post: any, i: number) => (
        <BlogCard
          client:idle
          slug={post.id}
          title={post.data.title}
          date={formatDateShort(post.data.date)}
          readTime={post.data.readTime}
          tags={post.data.tags}
          excerpt={post.data.excerpt}
          index={i}
        />
      ))}
    </div>
  </main>

  <Footer client:idle />
</BaseLayout>
